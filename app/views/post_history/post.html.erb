<h1>Post History</h1>

<div class="item-list">
  <%= render 'posts/type_agnostic', post: @post, show_category_tag: true, show_type_tag: true, last_activity: false %>
</div>

<% @history.each.with_index do |event, index| %>
  <% revision = @history.size - index %>
  <details class="history-event" id="<%= revision %>">
    <summary>
      <div>
        <strong>
          <% if event.reverted? %>
            <del>#<%= revision %>: <%= event.post_history_type.name.humanize %></del>
          <% else %>
            #<%= revision %>: <%= event.post_history_type.name.humanize %>
          <% end %>
        </strong>
        <span class="has-color-tertiary-600 history-meta">
          <span>
            by
            <% if deleted_user? event.user %>
              (deleted user)
            <% else %>
              <img class="avatar-16" alt="user avatar" src="<%= avatar_url(event.user) %>" height="16" width="16" />
              <%= user_link event.user %>
            <% end %>
            &middot;
            <%= event.created_at.iso8601 %> (<%= time_ago_in_words(event.created_at) %> ago)
          </span>
        <% if event.comment.present? %>
          <br/><em><%= sanitize(render_markdown(event.comment), scrubber: PostHistoryScrubber.new) %></em>
        <% end %>
        </span>
      </div>

      <div>
        <% if event.can_undo? && allow_undo_history?(event, current_user) %>
          <% if event.post_history_type.history_hiding_related? %>
            <% name = event.post_history_type.name == 'history_hidden' ? 'reveal history' : 're-hide history' %>
            <%= link_to name.titlecase, undo_post_history_url(@post, event),
                        'aria-label': "#{name.titlecase} at ##{revision}",
                        data: {
                          confirm: "Are you sure you want to #{name} at ##{revision}?"
                        },
                        method: :post
            %>
            &mdash;
          <% else %>
            <%= link_to 'Undo', undo_post_history_url(@post, event),
                        'aria-label': "Undo history item ##{revision} #{event.post_history_type.name.humanize}",
                        data: {
                          confirm: "Are you sure you want to undo change ##{revision}: #{event.post_history_type.name.humanize}?"
                        },
                        method: :post
            %>
            &mdash;
          <% end %>
        <% end %>

        <% if index != 0 && event.post_history_type.can_be_rolled_back_to? && allow_roll_back_to_history?(event, current_user) %>
          <%= link_to 'Roll back to this version', rollback_overview_post_history_path(@post, event),
                      'aria-label': "Roll back to version ##{revision} #{event.post_history_type.name.humanize}"
          %>
          &mdash;
        <% end %>

        <%= link_to post_history_url(@post, anchor: revision), class: 'js-permalink' do %>
          <span class="js-text">Copy Link</span>
        <% end %>
      </div>
    </summary>
    <% if event.allowed_to_see_details?(current_user) %>
      <% if event.hidden? %>
        <div class="notice is-warning is-filled">
          <p><i class="fas fa-info-circle"></i> <strong>Hidden revision</strong></p>
          <p>
            This revision is hidden because of a redaction. You have access to the details because
            <% if current_user == event.user %>
              you performed the redaction,
            <% elsif current_user == @post.user %>
              you are the post author,
            <% elsif current_user&.is_admin %>
              you are an administrator,
            <% end %>
            but you should not share this revision with others.
          </p>
        </div>
      <% end %>
      <% if (event.before_title.present? || event.after_title.present?) && event.before_title != event.after_title %>
        <%= render 'diff', before: event.before_title, after: event.after_title, post: @post %>
      <% end %>
      <% if (event.before_state.present? || event.after_state.present?) && event.before_state != event.after_state %>
        <%= render 'diff', before: event.before_state, after: event.after_state, post: @post %>
      <% end %>
      <% if (event.before_tags.present? || event.after_tags.present?) && event.before_tags != event.after_tags %>
        <%= render 'diff', before: event.before_tags, after: event.after_tags, post: @post %>
      <% end %>
    <% elsif [event.before_title, event.after_title,
              event.before_state, event.after_state,
              event.before_tags, event.after_tags].any?(&:present?) %>
      <p>
        <em>The detailed changes of this event are hidden because of a redaction.</em>
      </p>
    <% end %>
  </details>
<% end %>
