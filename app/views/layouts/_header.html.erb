<% logo_path = SiteSetting['SiteLogoPath'] %>
<% mobile_logo_path = SiteSetting['MobileLogoPath'] %>

<header class="header is-small has-margin-0 <%= SiteSetting['SiteHeaderIsDark'] ? 'is-dark' : '' %>">
  <div class="container header--container">
    <div class="header--brand">
      <% if mobile_logo_path.present? %>
        <a href="/" class="header--site-name __mobile-only" aria-label="Home"><img alt src="<%= mobile_logo_path %>" /></a>
        <% if logo_path.present? %>
          <a href="/" class="header--site-name __desktop-only" aria-label="Home"><img alt src="<%= logo_path %>" /></a>
        <% else %>
          <a href="/" class="header--site-name __desktop-only" aria-label="Home"><%= SiteSetting['SiteName'] %></a>
        <% end %>
      <% else %>
        <% if logo_path.present? %>
          <a href="/" class="header--site-name" aria-label="Home"><img alt src="<%= logo_path %>" /></a>
        <% else %>
          <a href="/" class="header--site-name" aria-label="Home"><%= SiteSetting['SiteName'] %></a>
        <% end %>
      <% end %>
    </div>
    <nav class="header--menu">
    <% unless @community.is_fake %>
        <%= link_to 'Categories', categories_path, class: 'header--item' %>
        <%= link_to 'Users', users_path, class: 'header--item' %>
        <%= link_to 'Search', search_path, class: 'header--item', data: { 'header-slide' => '#search-slide' } %>

        <div class='header--separator'></div>

        <%= link_to 'Help', help_center_path, class: 'header--item' %>
      <% else %>
        <div class='header--separator'></div>
      <% end %>
      <% if user_signed_in? %>
        <% unless @community.is_fake %>
          <% if current_user.is_moderator %>
            <%= link_to flag_queue_path, class: 'header--item' do %>
              <% if @open_flags > 0 %>
                <span class="header--alert"><%= @open_flags %></span>
              <% end %>
              Flags
            <% end %>
          <% end %>
        <% end %>
        <a href="#" class="header--item inbox-toggle is-visible-on-mobile" data-header-slide="#js-inbox">
          <% unread = current_user.unread_count %>
          <% if unread > 0 %>
            <span class="header--alert inbox-count"><%= unread %></span>
          <% end %>
          <i class='fas fa-inbox' title='Notifications'></i>
        </a>
        <%= link_to qr_login_code_path, class: 'header--item' do %>
          <i class="fas fa-mobile-alt" aria-label="Mobile Sign In" title="Mobile Sign In"></i>
        <% end %>
        <%= link_to user_path(current_user), class: 'header--item is-complex is-visible-on-mobile' do %>
          <img alt="user avatar" src="<%= avatar_url(current_user) %>" class="header--item-image">
        <% end %>
      <% end %>
      <a href="#" class="header--item" aria-label="Show Communities" data-header-slide="#communities-slide"><i class="far fa-caret-square-down"></i></a>
      <% unless user_signed_in? %>
        <div class="header--item">
          <%= link_to 'Sign Up', new_user_registration_path, class: 'button is-muted is-filled' %>
          <%= link_to 'Sign In', new_user_session_path, class: 'button is-muted is-outlined' %>
        </div>
      <% end %>
      <% unless @community.is_fake %>
      <a class="header--item is-mobile-menu is-complex" aria-label="Menu" href="#" data-header-slide="#js-mobile-menu">
          <span class="header--menu-bars">
            <span></span>
            <span></span>
            <span></span>
          </span>
      </a>
      <% end %>
    </nav>
  </div>
</header>

<div class="header-slide" id="communities-slide">
  <%= link_to 'Sign Out', destroy_user_session_path, method: :delete, class: 'button is-muted has-float-right' %>
  <h3 class="h-m-t-1">Communities</h3>
  <div class="community-header-list">
  <% Community.all.each do |c| %>
    <div class="community-header-list-entry">
      <% settings = SiteSetting.for_community_id(c.id) %>
      <% logo_setting = settings.find_by(name: 'SiteLogoPath') %>
      <%= link_to "//" + c.host do %>
        <% if !logo_setting.nil? %>
          <div class="img">
            <img src="<%= logo_setting&.typed %>" alt="<%= c.name %>" class="community-header-list-image">
          </div>
        <% end %>
        <div class="label">
          <%= c.name %>
        </div>
      <% end %>
    </div>
  <% end %>
  </div>
</div>

<div class="header-slide is-large" id="search-slide">
  <%= form_tag search_path, method: :get do %>
    <div class="grid is-nowrap">
        <%= text_field_tag :search, params[:search], class: 'form-element' %>
        <div class="h-m-1">
          <%= button_tag type: :submit, class: 'button is-filled is-outlined', name: nil do %>
            <i class="fa fa-search"></i>
          <% end %>
        </div>
    </div>
  <% end %>
</div>

<div class="header-slide inbox h-p-0" id="js-inbox">
  <div class="h-p-2 h-bg-tertiary-050 h-fw-bold">Notifications</div>
  <div class="inbox--container h-p-2"></div>
  <div class="h-p-2 h-bg-tertiary-050 h-fw-bold">
    <a class="no-unread js-read-all-notifs" href="#"><i class="fas fa-envelope-open"></i> Mark all as read</a>
  </div>
</div>
<% unless @community.is_fake %>
<div class="header-slide mobile-menu" id="js-mobile-menu">
  <div class="menu">
    <%= link_to 'Categories', categories_path, class: 'menu--item' %>
    <%= link_to 'Users', users_path, class: 'menu--item' %>
    <%= link_to 'Search', search_path, class: 'menu--item' %>

    <div class='header-slide--separator'></div>

    <%= link_to 'Help', help_center_path, class: 'menu--item' %>

    <% if user_signed_in? %>
      <% if current_user.is_admin || current_user.is_moderator %>
        <%= link_to flag_queue_path, class: 'menu--item' do %>
          <% if @open_flags > 0 %>
            <span class="badge is-status"><%= @open_flags %></span>
          <% end %>
          Flags
        <% end %>
      <% end %>
      <%= link_to 'Sign Out', destroy_user_session_path, method: :delete, class: 'menu--item' %>
    <% end %>
  </div>
</div>
<% end %>


<% unless @community.is_fake %>
<% if expandable? %>
  <% current_cat = current_category %>
  <% header_class = current_cat.color_code.present? ? current_cat.color_code : SiteSetting['SiteCategoryHeaderDefaultColor'] %>
<% else %>
  <% header_class = SiteSetting['SiteCategoryHeaderDefaultColor'] %>
<% end %>
<header class="category-header is-<%= header_class %>">
  <div class="category-header--tabs">
    <div class="container category-header--tabs-container">
      <% @header_categories.each do |cat| %>
        <% next unless (current_user&.trust_level || 0) >= (cat.min_view_trust_level || -1) %>
        <%= link_to category_path(cat), class: "category-header--tab #{active?(cat) ? 'is-active' : ''}" do %>
          <%= cat.name %>
          <% if user_signed_in? && cat.new_posts_for?(current_user) %>
            <span class="badge is-status" title="new posts for you"></span>
          <% end %>
        <% end %>
      <% end %>
    </div>
  </div>
  <% if expandable? %>
    <div class="container category-header--container">
      <div class="category-header--name"><%= current_cat.name %></div>
      <div class="category-header--nav">
        <%= link_to 'Posts', category_path(current_cat),
                    class: "category-header--nav-item #{active?(current_cat) && controller_name != 'tags' ? 'is-active' : ''}" %>
        <%= link_to 'Tags', category_tags_path(current_cat),
                    class: "category-header--nav-item #{active?(current_cat) && controller_name == 'tags' ? 'is-active' : ''}" %>
        <div class="category-header--nav-separator"></div>
        <%= link_to category_post_types_path(current_cat.id),
                    class: 'category-header--nav-item is-button' do %>
          <%= current_cat.button_text.present? ? current_cat.button_text : 'Create Post' %>
        <% end %>
      </div>
    </div>
  <% end %>
</header>

<% end %>

<% if Rails.env.development? %>
  <div class="notice is-danger is-banner has-padding-2 notice__dev-mode">
    <div class="container">
      <p>This site is in development mode!</p>
    </div>
  </div>
<% end %>

<% if RequestContext.redis.exists? 'banner_text' %>
  <div class="notice is-filled <%= RequestContext.redis.get('banner_class') || 'is-warning' %> has-padding-2 is-banner">
    <div class="container">
      <%= RequestContext.redis.get 'banner_text' %>
    </div>
  </div>
<% end %>