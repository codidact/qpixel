<%#
    Comment thread view.
    params[:inline] : If true shown within the Q&A page, else shown as separate comment thread page
%>

<% pingable = get_pingable(@comment_thread) %>

<h1>Comments on
  <a href="<%= generic_share_link(@post) %>"><%= @post.title.blank? && @post.parent.present? ? @post.parent.title : @post.title %></a>
</h1>

<% if @post.parent.present? %>
  <details>
    <summary>Parent</summary>
    <%= render 'posts/expanded', post: @post.parent %>
  </details>
<% end %>

<details>
  <summary>Post</summary>
  <%= render 'posts/expanded', post: @post %>
</details>

<!-- THREAD STARTS BELOW -->
<div class="<%= @comment_thread.deleted ? 'h-bg-red-050' : '' %> <%= params[:inline] == 'true' ? 'post--comments-thread is-embedded' : '' %>">
  <div class="widget thread <%= @comment_thread.deleted ? 'is-red' : '' %>" data-deleted="<%= @comment_thread.deleted %>"
      data-archived="<%= @comment_thread.archived %>" data-thread="<%= @comment_thread.id %>"
      data-comments="<%= @comment_thread.reply_count %>" data-post="<%= @post.id %>">
    <div class="widget--header">
      <% if params[:inline] == 'true' %>
        <a href="<%= comment_thread_path(@comment_thread.id) %>" class="widget--header-link">show thread</a>
        <a href="javascript:void(0)" class="js-collapse-thread widget--header-link">collapse</a>
      <% end %>
      <% if current_user&.privilege?('flag_curate') %>
        <%= render 'thread_tools_link', thread: @comment_thread %>
      <% end %>
      <% unless current_user.nil? %>
        <%= render 'thread_follow_link', thread: @comment_thread, user: current_user %>
      <% end %>
      <% if @comment_thread.deleted %>
        <i class="fas fa-trash fa-fw" title="Deleted. This thread has been deleted."></i>
      <% elsif @comment_thread.archived %>
        <i class="fas fa-archive fa-fw" title="Archived. This thread is outdated/completed and hence cannot be modified."></i>
      <% elsif @comment_thread.locked? %>
        <i class="fas fa-lock fa-fw" title="Locked. This thread has been locked and cannot be modified."></i>
      <% end %>
      <span class="js-thread-title"><%= @comment_thread.title %></span>
    </div>
    <% skipped_deleted = 0 %>
    <% comments = @comment_thread.comments %>
    <% if params[:inline] == 'true' %>
      <% count = 0 %>
      <% comments = comments.take_while do |comment| %>
        <% count += 1 unless comment.deleted %>
        <% count <= 5 %>
      <% end %>
    <% end %>
    <div role="list">
      <% comments.each do |comment| %>
        <% if comment.deleted && !(current_user&.at_least_moderator? && params[:show_deleted_comments] == "1") %>
          <% skipped_deleted += 1%>
          <% next %>
        <% elsif skipped_deleted > 0 %>
          <div class="widget--body" role="listitem">
            <%= render 'comments/skip_deleted', skipped_deleted: skipped_deleted%>
          </div>
          <% skipped_deleted = 0 %>
        <% end %>
        <div class="widget--body" role="listitem">
          <%= render 'comments/comment', comment: comment, pingable: pingable %>
        </div>
      <% end %>
      <% if skipped_deleted > 0 %>
        <div class="widget--body" role="listitem">
          <%= render 'comments/skip_deleted', skipped_deleted: skipped_deleted%>
        </div>
        <% skipped_deleted = 0 %>
      <% end %>
    </div>
    <% unless current_user.nil? || params[:inline] == 'true' %>
      <div class="widget--footer">
        <%= render 'reply_to_thread', post: @post, thread: @comment_thread, user: current_user %>
      </div>
    <% end %>
    <% if params[:inline] == 'true' %>
      <div class="widget--footer">
        <p class="h-m-0">
          Showing <%= [5, @comment_thread.reply_count].min %> of <%= pluralize(@comment_thread.reply_count, 'comment') %>.
          <%= link_to 'See the whole thread', comment_thread_path(@comment_thread) %>.
        </p>
      </div>
    <% end %>
  </div>
</div>

<% if current_user&.privilege?('flag_curate') %>
  <%= render 'thread_actions_modal', thread: @comment_thread, user: current_user %>

  <%= render 'rename_thread_modal', thread: @comment_thread %>

  <div class="modal is-with-backdrop is-small js--lock-thread-<%= @comment_thread.id %>">
    <%= form_tag restrict_comment_thread_path(@comment_thread.id), class: 'modal--container' do %>
      <%= hidden_field_tag :type, 'lock' %>
      <div class="modal--header">
        <button type="button" class="button is-close-button modal--header-button" data-modal=".js--lock-thread-<%= @comment_thread.id %>">&times;</button>
        Lock...
      </div>
      <div class="modal--body">
        <%= label_tag :duration, 'Duration in days (optional)', class: 'form-element' %>
        <div class="form-caption">You may enter a lock duration in days. If you leave this blank, the thread will need to be unlocked manually.</div>
        <%= number_field_tag :duration, nil, class: 'form-element' %>
      </div>
      <div class="modal--footer">
        <%= submit_tag 'Lock thread', class: 'button is-muted is-filled' %>
        <button type="button" class="button is-muted" data-modal=".js--lock-thread-<%= @comment_thread.id %>">Cancel</button>
      </div>
    <% end %>
  </div>

  <% if current_user&.at_least_moderator? %>
    <div class="modal is-with-backdrop is-small" id="js-followers-<%= @comment_thread.id %>">
      <div class="modal--container">
        <div class="modal--header">
          <button type="button" class="button is-close-button modal--header-button" data-modal="#js-followers-<%= @comment_thread.id %>">&times;</button>
          Thread Followers
        </div>
        <div class="modal--body js-follower-display">
          Loading...
        </div>
      </div>
    </div>
  <% end %>
<% end %>

<!-- THREAD ENDS ABOVE -->
